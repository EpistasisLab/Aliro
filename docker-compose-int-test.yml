version: '3'

services: 

  tester:
    build: ./tests/integration
    #command: bash
    #command: npm test
    #See <https://github.com/vishnubob/wait-for-it>
    #command: ["/opt/wait-for-it.sh", "-t", "200", "lab:5080", "--", "npm", "test"]
    depends_on: 
      - lab
      - machine
      - dbmongo
    tty: true
    stdin_open: true
    volumes: 
      - "./tests/integration/jest:/src/jest"
      - "./target:/target"

  lab:
    build: 
      context: .
      dockerfile: dockers/lab/Dockerfile
    tty: true
    stdin_open: true
    volumes: 
      - "./:/appsrc"
      - "/appsrc/lab/webapp/node_modules"
      - "/appsrc/lab/node_modules"
    ports:
      - "443:443"
      - "5080:5080"
    environment:
      - AI_AUTOSTART=0
    env_file: ./config/common.env
    depends_on: 
      - dbmongo

  machine:
    build: 
      context: .
      dockerfile: dockers/machine/Dockerfile
    tty: true
    stdin_open: true
    volumes: 
      - "./:/appsrc"
      - "/appsrc/machine/node_modules"
    ports: 
      - "5081:5081"
    env_file: ./config/common.env
    depends_on: 
      - lab
      - dbmongo

  dbmongo:
    build: ./dockers/dbmongo
    tty: true
    stdin_open: true
    volumes: 
      - "./:/appsrc"
    ports:  
      - "27017:27017"
    env_file: ./config/common.env
